[{"id": "order_attribution", "parentIds": [], "sql": "(SELECT *\n FROM   order_attribution\n WHERE  source_country = 'US')", "cols": [{"name": "all", "sql": "*"}]}, {"id": "fct_orders", "parentIds": [], "sql": "(SELECT *\n FROM   fct_orders\n WHERE  source_country = 'US')", "cols": [{"name": "all", "sql": "*"}]}, {"id": "survey_weighting", "parentIds": ["gsheets.mta_survey_weighting"], "sql": "(SELECT *\n FROM   gsheets.mta_survey_weighting)", "cols": [{"name": "all", "sql": "*"}]}, {"id": "ad_performance", "parentIds": [], "sql": "(SELECT *\n FROM   ad_performance\n WHERE  source_country = 'US')", "cols": [{"name": "all", "sql": "*"}]}, {"id": "session_credit_attribution", "parentIds": ["order_attribution", "fct_orders"], "sql": "(SELECT f.order_id,\n        f.created_at,\n        o.session_id,\n        (f.total_gross_revenue - f.total_tax) as revenue,\n        f.new_vs_repeat,\n        o.attribution_channel,\n        o.survey_channel,\n        o.survey_response,\n        coalesce(o.order_total_sessions,\n                 1) as order_total_sessions,\n        coalesce(o.order_session_number,\n                 1) as order_session_number,\n        coalesce(o.fortyfive_ten_fortyfive_points,\n                 1) as fortyfive_ten_fortyfive_points,\n        coalesce(o.fortyfive_ten_fortyfive_revenue,\n                 f.total_gross_revenue - f.total_tax) as fortyfive_ten_fortyfive_revenue,\n        case when o.attribution_channel = o.survey_channel then 1\n             else 0 end as survey_click_match,\n        case when attribution_channel = 'Direct' or\n                  attribution_channel is null or\n                  attribution_channel = 'Organic search' or\n                  (attribution_channel = 'Email' and\n                  f.new_vs_repeat = 'new') or\n                  attribution_channel like '% brand search%' then 1\n             else 0 end as session_has_direct\n FROM   fct_orders as f\n     LEFT JOIN order_attribution as o\n         ON f.order_id = o.order_id\n WHERE  f.is_completed = 1)", "cols": [{"name": "order_id", "sql": "f.order_id"}, {"name": "created_at", "sql": "f.created_at"}, {"name": "session_id", "sql": "o.session_id"}, {"name": "revenue", "sql": "(f.total_gross_revenue - f.total_tax) AS revenue"}, {"name": "new_vs_repeat", "sql": "f.new_vs_repeat"}, {"name": "attribution_channel", "sql": "o.attribution_channel"}, {"name": "survey_channel", "sql": "o.survey_channel"}, {"name": "survey_response", "sql": "o.survey_response"}, {"name": "order_total_sessions", "sql": "COALESCE(o.order_total_sessions, 1) AS order_total_sessions"}, {"name": "order_session_number", "sql": "COALESCE(o.order_session_number, 1) AS order_session_number"}, {"name": "fortyfive_ten_fortyfive_points", "sql": "COALESCE(o.fortyfive_ten_fortyfive_points, 1) AS fortyfive_ten_fortyfive_points"}, {"name": "fortyfive_ten_fortyfive_revenue", "sql": "COALESCE(o.fortyfive_ten_fortyfive_revenue, f.total_gross_revenue - f.total_tax) AS fortyfive_ten_fortyfive_revenue"}, {"name": "survey_click_match", "sql": "CASE WHEN o.attribution_channel = o.survey_channel THEN 1 ELSE 0 END AS survey_click_match"}, {"name": "session_has_direct", "sql": "CASE WHEN attribution_channel = 'Direct' OR attribution_channel IS NULL OR attribution_channel = 'Organic search' OR (attribution_channel = 'Email' AND f.new_vs_repeat = 'new') OR attribution_channel LIKE '% brand search%' THEN 1 ELSE 0 END AS session_has_direct"}]}, {"id": "attributed_credit", "parentIds": ["session_credit_attribution"], "sql": "(SELECT attribution_channel,\n        new_vs_repeat,\n        date_trunc(date(created_at, \"America/New_York\"),\n                   day) as created_at,\n        case when attribution_channel = 'Direct' then 1\n             when attribution_channel is null then 1\n             when attribution_channel = 'Organic search' then 1\n             when attribution_channel = 'Email' and\n                  new_vs_repeat = 'new' then 1\n             when attribution_channel like '% brand search%' then 0.7\n             else 0 end as pct_credit_giveback,\n        sum(fortyfive_ten_fortyfive_points) as attributed_orders,\n        sum(fortyfive_ten_fortyfive_revenue) as attributed_revenue\n FROM   session_credit_attribution)", "cols": [{"name": "attribution_channel", "sql": "attribution_channel"}, {"name": "new_vs_repeat", "sql": "new_vs_repeat"}, {"name": "created_at", "sql": "DATE_TRUNC(DATE(created_at, \"America/New_York\"), day) AS created_at"}, {"name": "pct_credit_giveback", "sql": "CASE WHEN attribution_channel = 'Direct' THEN 1 WHEN attribution_channel IS NULL THEN 1 WHEN attribution_channel = 'Organic search' THEN 1 WHEN attribution_channel = 'Email' AND new_vs_repeat = 'new' THEN 1 WHEN attribution_channel LIKE '% brand search%' THEN 0.7 ELSE 0 END AS pct_credit_giveback"}, {"name": "attributed_orders", "sql": "SUM(fortyfive_ten_fortyfive_points) AS attributed_orders"}, {"name": "attributed_revenue", "sql": "SUM(fortyfive_ten_fortyfive_revenue) AS attributed_revenue"}]}, {"id": "credit_giveback", "parentIds": ["attributed_credit"], "sql": "(SELECT attribution_channel,\n        new_vs_repeat,\n        created_at,\n        attributed_orders * pct_credit_giveback as giveback_orders,\n        attributed_revenue * pct_credit_giveback as giveback_revenue,\n        attributed_orders * (1 - pct_credit_giveback) as post_giveback_orders,\n        attributed_revenue * (1 - pct_credit_giveback) as post_giveback_revenue\n FROM   attributed_credit)", "cols": [{"name": "attribution_channel", "sql": "attribution_channel"}, {"name": "new_vs_repeat", "sql": "new_vs_repeat"}, {"name": "created_at", "sql": "created_at"}, {"name": "giveback_orders", "sql": "attributed_orders * pct_credit_giveback AS giveback_orders"}, {"name": "giveback_revenue", "sql": "attributed_revenue * pct_credit_giveback AS giveback_revenue"}, {"name": "post_giveback_orders", "sql": "attributed_orders * (1 - pct_credit_giveback) AS post_giveback_orders"}, {"name": "post_giveback_revenue", "sql": "attributed_revenue * (1 - pct_credit_giveback) AS post_giveback_revenue"}]}, {"id": "attributable_credit", "parentIds": ["credit_giveback"], "sql": "(SELECT new_vs_repeat,\n        created_at,\n        sum(giveback_orders) as attributable_orders,\n        sum(giveback_revenue) as attributable_revenue\n FROM   credit_giveback)", "cols": [{"name": "new_vs_repeat", "sql": "new_vs_repeat"}, {"name": "created_at", "sql": "created_at"}, {"name": "attributable_orders", "sql": "SUM(giveback_orders) AS attributable_orders"}, {"name": "attributable_revenue", "sql": "SUM(giveback_revenue) AS attributable_revenue"}]}, {"id": "survey_clean", "parentIds": ["session_credit_attribution"], "sql": "(SELECT survey_channel,\n        survey_response,\n        date_trunc(date(created_at, \"America/New_York\"),\n                   day) as created_at,\n        new_vs_repeat,\n        count(distinct order_id) as survey_response_count\n FROM   session_credit_attribution\n WHERE  survey_click_match = 0\n    and session_has_direct = 1)", "cols": [{"name": "survey_channel", "sql": "survey_channel"}, {"name": "survey_response", "sql": "survey_response"}, {"name": "created_at", "sql": "DATE_TRUNC(DATE(created_at, \"America/New_York\"), day) AS created_at"}, {"name": "new_vs_repeat", "sql": "new_vs_repeat"}, {"name": "survey_response_count", "sql": "COUNT(DISTINCT order_id) AS survey_response_count"}]}, {"id": "num_bucket_options", "parentIds": ["fct_hdyhau"], "sql": "(SELECT survey_response,\n        count(distinct survey_channel) as num_options\n FROM   fct_hdyhau\n WHERE  not lower(survey_channel) like '%general%')", "cols": [{"name": "survey_response", "sql": "survey_response"}, {"name": "num_options", "sql": "COUNT(DISTINCT survey_channel) AS num_options"}]}, {"id": "survey_response_direct", "parentIds": ["survey_clean", "survey_weighting"], "sql": "(SELECT survey_channel,\n        survey_response,\n        created_at,\n        new_vs_repeat,\n        sum(survey_response_count * weight) as direct_survey_response_count\n FROM   survey_clean\n     INNER JOIN survey_weighting\n         ON survey_clean.survey_channel = survey_weighting.survey_channel)", "cols": [{"name": "survey_channel", "sql": "survey_channel"}, {"name": "survey_response", "sql": "survey_response"}, {"name": "created_at", "sql": "created_at"}, {"name": "new_vs_repeat", "sql": "new_vs_repeat"}, {"name": "direct_survey_response_count", "sql": "SUM(survey_response_count * weight) AS direct_survey_response_count"}]}, {"id": "general_redistribution", "parentIds": ["num_bucket_options", "survey_response_direct"], "sql": "(SELECT survey_response,\n        created_at,\n        new_vs_repeat,\n        sum(direct_survey_response_count) / max(num_options) as redistirbuted_count\n FROM   survey_response_direct as d\n     LEFT JOIN num_bucket_options as n\n         ON d.survey_response = n.survey_response\n WHERE  d.survey_channel like '%general%'\n GROUP BY 1, 2, 3)", "cols": [{"name": "survey_response", "sql": "survey_response"}, {"name": "created_at", "sql": "created_at"}, {"name": "new_vs_repeat", "sql": "new_vs_repeat"}, {"name": "redistirbuted_count", "sql": "SUM(direct_survey_response_count) / MAX(num_options) AS redistirbuted_count"}]}, {"id": "survey_end", "parentIds": ["general_redistribution", "survey_response_direct"], "sql": "(SELECT d.survey_channel,\n        d.created_at,\n        d.new_vs_repeat,\n        d.direct_survey_response_count + coalesce(r.redistirbuted_count,\n                                                  0) as direct_survey_response_count\n FROM   survey_response_direct as d\n     LEFT JOIN general_redistribution as r\n         ON r.survey_response = d.survey_response and\n            r.created_at = d.created_at and\n            r.new_vs_repeat = d.new_vs_repeat\n WHERE  not d.survey_channel like '%general%')", "cols": [{"name": "survey_channel", "sql": "d.survey_channel"}, {"name": "created_at", "sql": "d.created_at"}, {"name": "new_vs_repeat", "sql": "d.new_vs_repeat"}, {"name": "direct_survey_response_count", "sql": "d.direct_survey_response_count + COALESCE(r.redistirbuted_count, 0) AS direct_survey_response_count"}]}, {"id": "survey_distribution", "parentIds": ["survey_end"], "sql": "(SELECT survey_channel,\n        created_at,\n        new_vs_repeat,\n        direct_survey_response_count / sum(direct_survey_response_count) OVER(PARTITION BY created_at,\n                                                                                           new_vs_repeat) as survey_composition\n FROM   survey_end\n WHERE  direct_survey_response_count > 0)", "cols": [{"name": "survey_channel", "sql": "survey_channel"}, {"name": "created_at", "sql": "created_at"}, {"name": "new_vs_repeat", "sql": "new_vs_repeat"}, {"name": "survey_composition", "sql": "direct_survey_response_count / SUM(direct_survey_response_count) OVER(PARTITION BY created_at, new_vs_repeat) AS survey_composition"}]}, {"id": "reattributed_credit", "parentIds": ["attributable_credit", "survey_distribution"], "sql": "(SELECT new_vs_repeat,\n        created_at,\n        survey_channel,\n        attributable_orders * survey_composition as reattributed_orders,\n        attributable_revenue * survey_composition as reattributed_revenue\n FROM   attributable_credit as a\n     LEFT JOIN survey_distribution as b\n         ON a.new_vs_repeat = b.new_vs_repear and\n            a.created_at = b.created_at)", "cols": [{"name": "new_vs_repeat", "sql": "new_vs_repeat"}, {"name": "created_at", "sql": "created_at"}, {"name": "survey_channel", "sql": "survey_channel"}, {"name": "reattributed_orders", "sql": "attributable_orders * survey_composition AS reattributed_orders"}, {"name": "reattributed_revenue", "sql": "attributable_revenue * survey_composition AS reattributed_revenue"}]}, {"id": "order_join", "parentIds": ["reattributed_credit", "credit_giveback"], "sql": "(SELECT attribution_channel as marketing_channel,\n        new_vs_repeat,\n        created_at,\n        post_giveback_orders as orders,\n        post_giveback_revenue as revenue\n FROM   credit_giveback\n UNION all\nSELECT case when lower(survey_channel) like '%radio%' then 'Radio am/fm'\n             when lower(survey_channel) like '%tv%' then 'TV'\n             else survey_channel end as marketing_channel,\n        new_vs_repeat,\n        created_at,\n        reattributed_orders as orders,\n        reattributed_revenue as revenue\n FROM   reattributed_credit)", "cols": [{"name": "marketing_channel", "sql": "CASE WHEN LOWER(survey_channel) LIKE '%radio%' THEN 'Radio am/fm' WHEN LOWER(survey_channel) LIKE '%tv%' THEN 'TV' ELSE survey_channel END AS marketing_channel"}, {"name": "new_vs_repeat", "sql": "new_vs_repeat"}, {"name": "created_at", "sql": "created_at"}, {"name": "orders", "sql": "reattributed_orders AS orders"}, {"name": "revenue", "sql": "reattributed_revenue AS revenue"}]}, {"id": "order_join_calc", "parentIds": ["order_join"], "sql": "(SELECT marketing_channel,\n        coalesce(new_vs_repeat,\n                 \"new\") as new_vs_repeat,\n        created_at,\n        sum(orders) as orders,\n        sum(revenue) as revenue\n FROM   order_join)", "cols": [{"name": "marketing_channel", "sql": "marketing_channel"}, {"name": "new_vs_repeat", "sql": "COALESCE(new_vs_repeat, \"new\") AS new_vs_repeat"}, {"name": "created_at", "sql": "created_at"}, {"name": "orders", "sql": "SUM(orders) AS orders"}, {"name": "revenue", "sql": "SUM(revenue) AS revenue"}]}, {"id": "order_join_final", "parentIds": ["order_join_calc"], "sql": "(SELECT marketing_channel,\n        created_at,\n        coalesce(sum(case when new_vs_repeat = 'new' then revenue\n                          else 0 end), 0) as new_attributed_revenue,\n        coalesce(sum(case when new_vs_repeat = 'repeat' then revenue\n                          else 0 end), 0) as repeat_attributed_revenue,\n        coalesce(sum(case when new_vs_repeat = 'new' then orders\n                          else 0 end), 0) as new_attributed_orders,\n        coalesce(sum(case when new_vs_repeat = 'repeat' then orders\n                          else 0 end), 0) as repeat_attributed_orders\n FROM   order_join_calc)", "cols": [{"name": "marketing_channel", "sql": "marketing_channel"}, {"name": "created_at", "sql": "created_at"}, {"name": "new_attributed_revenue", "sql": "COALESCE(SUM(CASE WHEN new_vs_repeat = 'new' THEN revenue ELSE 0 END), 0) AS new_attributed_revenue"}, {"name": "repeat_attributed_revenue", "sql": "COALESCE(SUM(CASE WHEN new_vs_repeat = 'repeat' THEN revenue ELSE 0 END), 0) AS repeat_attributed_revenue"}, {"name": "new_attributed_orders", "sql": "COALESCE(SUM(CASE WHEN new_vs_repeat = 'new' THEN orders ELSE 0 END), 0) AS new_attributed_orders"}, {"name": "repeat_attributed_orders", "sql": "COALESCE(SUM(CASE WHEN new_vs_repeat = 'repeat' THEN orders ELSE 0 END), 0) AS repeat_attributed_orders"}]}, {"id": "ad_spend", "parentIds": ["ad_performance"], "sql": "(SELECT date_trunc(date_day,\n                   day) as created_at,\n        ad_channel as marketing_channel,\n        sum(spend) as spend\n FROM   ad_performance)", "cols": [{"name": "created_at", "sql": "DATE_TRUNC(date_day, day) AS created_at"}, {"name": "marketing_channel", "sql": "ad_channel AS marketing_channel"}, {"name": "spend", "sql": "SUM(spend) AS spend"}]}, {"id": "final", "parentIds": ["order_join_final", "ad_spend"], "sql": "(SELECT marketing_channel,\n        created_at,\n        coalesce(new_attributed_revenue,\n                 0) as new_attributed_revenue,\n        coalesce(repeat_attributed_revenue,\n                 0) as repeat_attributed_revenue,\n        coalesce(new_attributed_orders,\n                 0) as new_attributed_orders,\n        coalesce(repeat_attributed_orders,\n                 0) as repeat_attributed_orders,\n        coalesce(spend,\n                 0) as spend\n FROM   order_join_final as a\n     LEFT JOIN ad_spend as b\n         ON a.created_at = b.created_at and\n            a.marketing_channel = b.marketing_channel)", "cols": [{"name": "marketing_channel", "sql": "marketing_channel"}, {"name": "created_at", "sql": "created_at"}, {"name": "new_attributed_revenue", "sql": "COALESCE(new_attributed_revenue, 0) AS new_attributed_revenue"}, {"name": "repeat_attributed_revenue", "sql": "COALESCE(repeat_attributed_revenue, 0) AS repeat_attributed_revenue"}, {"name": "new_attributed_orders", "sql": "COALESCE(new_attributed_orders, 0) AS new_attributed_orders"}, {"name": "repeat_attributed_orders", "sql": "COALESCE(repeat_attributed_orders, 0) AS repeat_attributed_orders"}, {"name": "spend", "sql": "COALESCE(spend, 0) AS spend"}]}, {"id": "gsheets.mta_survey_weighting", "parentIds": [], "sql": "select * from gsheets.mta_survey_weighting", "cols": [{"name": "all", "sql": "*"}]}, {"id": "fct_hdyhau", "parentIds": [], "sql": "select * from fct_hdyhau", "cols": [{"name": "all", "sql": "*"}]}]